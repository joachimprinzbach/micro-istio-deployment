{{ range .Values.services }}
---
apiVersion: v1
kind: Service
metadata:
    name: {{ .name }}
    labels:
        app: {{ .name }}
        chart: {{ template "istio.chart" $ }}
        release: {{ $.Release.Name }}
        heritage: {{ $.Release.Service }}
spec:
    type: {{ default "ClusterIP" .type }}
    ports:
        - port: {{ .appPort }}
          targetPort: {{ .appPort }}
          name: http
    selector:
        app: {{ default .name .appName }}
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ .name }}
spec:
{{- if .gateway}}
  hosts:
    - "*"
  gateways:
  - {{ template "istio.name" $ }}
{{- else }}
  hosts:
    - "{{ .name }}"
{{- end }}
  http:
{{- $service := .}}
{{- range $service.versions }}
    - match:
{{- if $service.paths }}
{{- range $service.paths }}
        - uri:
            prefix: {{ . }}
{{- end }}
{{- end }}
{{- if .cookieRegex }}
        - headers:
            cookie:
              regex: "{{ .cookieRegex }}"
{{- end }}
      route:
          - destination:
              host: {{ $service.name }}
              subset: {{ .name }}
              port:
                number: {{ $service.appPort }}
{{- if .weight }}
            weight: {{ .weight }}
{{- end }}
{{- end }}
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: {{ .name }}
spec:
  host: {{ .name }}
  subsets:
{{- range .subsets }}
    - name: {{ .name }}
      labels:
        version: {{ .name }}
{{- end }}
{{- end }}